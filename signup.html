<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Become a Helpa - YourHelpa</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="styles/style.css">
    <style>
        body { background-color: var(--background-color); }
        .signup-container { max-width: 500px; margin: 3rem auto; padding: 2.5rem; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .section-header { text-align: center; margin-bottom: 2rem; }
        .section-header p { color: var(--text-muted-color); }
        .form-fieldset { border: none; border-top: 1px solid var(--border-color); padding: 2rem 0 0.5rem; margin: 0; }
        .form-fieldset:first-of-type { border-top: none; padding-top: 0; }
        .form-fieldset legend { font-size: 1.1rem; font-weight: 600; padding: 0; margin-bottom: 1.5rem; color: var(--text-color); }
        .form-group { margin-bottom: 1.5rem; }
        #error-message, #success-message { padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: none; }
        #error-message { color: #e53e3e; background-color: rgba(229, 62, 62, 0.1); }
        #success-message { background-color: rgba(5, 170, 22, 0.1); color: var(--primary-color); }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; }
        /* Add a clear focus state for better accessibility and UX */
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: 2px solid transparent;
            box-shadow: 0 0 0 2px var(--surface-color), 0 0 0 4px var(--primary-color-light);
        }
        .radio-group { display: flex; gap: 1.5rem; margin-top: 0.5rem; }
        .radio-label { display: flex; align-items: center; gap: 0.5rem; font-weight: normal; cursor: pointer; }
        .radio-label input[type="radio"] { width: auto; }
        .auth-footer { text-align: center; margin-top: 1.5rem; font-size: 0.9rem; }
        /* Password toggle styles */
        .password-wrapper {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            display: flex; /* To center the SVG icons */
            align-items: center;
            justify-content: center;
        }
        .auth-footer a { color: var(--primary-color); font-weight: 500; }

        /* Mobile-specific adjustments */
        @media (max-width: 600px) {
            .signup-container { margin: 1rem; padding: 2rem 1.5rem; border: none; box-shadow: none; }
            body { background-color: var(--surface-color); }
        }
    </style>
</head>
<body>
    <div id="header-placeholder"></div>

    <main>
        <div class="signup-container">
            <div class="section-header">
                <h2>Become a Helpa</h2>
                <p>Complete the form below to start connecting with customers.</p>
            </div>
            
            <div id="error-message"></div>
            <div id="success-message" style="display: none;"></div>

            <form id="helpa-signup-form">
                <fieldset class="form-fieldset">
                    <legend>Personal Information</legend>
                    <div class="form-group">
                        <label for="full-name">Full Name</label>
                        <input type="text" id="full-name" name="full-name" placeholder="e.g., John Doe" required autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label for="phone-number">Phone Number (WhatsApp preferred)</label>
                        <input type="tel" id="phone-number" name="phone-number" placeholder="e.g., 08012345678" required autocomplete="tel">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="you@example.com" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="password-wrapper">
                            <input type="password" id="password" name="password" placeholder="Minimum 6 characters" required autocomplete="new-password">
                            <span class="toggle-password" id="toggle-password">
                                <svg class="eye-icon" aria-label="Show password" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                <svg class="eye-off-icon" aria-label="Hide password" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-10-7-10-7a18.09 18.09 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 10 7 10 7a18.09 18.09 0 0 1-2.07 2.91m-2.19-2.19a3 3 0 0 0-4.24-4.24m3.35 3.35a3 3 0 0 1-4.24 4.24"/><line x1="1" x2="23" y1="1" y2="23"/></svg>
                            </span>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-fieldset">
                    <legend>Location</legend>
                    <div class="form-group">
                        <label for="location">Your Location (City)</label>
                        <div id="autocomplete-container">
                            <input type="text" id="location" name="location" placeholder="e.g. Ikeja, Lagos" required autocomplete="address-level2">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-fieldset">
                    <legend>What do you offer?</legend>
                    <div class="form-group">
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" id="offering-type-service" name="offering_type" value="service" required>
                                Service
                            </label>
                            <label class="radio-label">
                                <input type="radio" id="offering-type-product" name="offering_type" value="product" required>
                                Product
                            </label>
                        </div>
                    </div>
                    <div id="primary-service-group" class="form-group" style="display: none;">
                        <label for="primary-service">Primary Service</label>
                        <input type="text" id="primary-service" name="primary_service" placeholder="e.g., Home Cleaning, Tutoring">
                    </div>
                    <div id="primary-product-group" class="form-group" style="display: none;">
                        <label for="primary-product">Primary Product</label>
                        <input type="text" id="primary-product" name="primary_product" placeholder="e.g., Handmade Jewelry, Organic Produce">
                    </div>
                </fieldset>
                <input type="hidden" id="location-selected" name="location_selected" value="false">
                <button type="submit" id="submit-btn" class="button-primary large" style="width: 100%;">Complete Registration</button>
            </form>

            <div class="auth-footer">
                <p>Already have an account? <a href="login.html">Login</a></p>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/main.js"></script>
    <script src="js/includes.js"></script>
    <script src="https://api.geoapify.com/v1/api.js"></script>
    <script>

        // Signup Logic
        const form = document.getElementById('helpa-signup-form');
        const submitButton = document.getElementById('submit-btn');
        const errorMessageDiv = document.getElementById('error-message');
        const successMessageDiv = document.getElementById('success-message');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const togglePassword = document.getElementById('toggle-password');
        const offeringTypeServiceRadio = document.getElementById('offering-type-service');
        const offeringTypeProductRadio = document.getElementById('offering-type-product');
        const primaryServiceGroup = document.getElementById('primary-service-group');
        const primaryProductGroup = document.getElementById('primary-product-group');
        const primaryServiceInput = document.getElementById('primary-service');
        const primaryProductInput = document.getElementById('primary-product');
        const locationInput = document.getElementById('location');
        const locationSelectedInput = document.getElementById('location-selected');

        // --- Password Toggle Logic ---
        if (togglePassword && passwordInput) {
            togglePassword.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                togglePassword.querySelector('.eye-icon').style.display = type === 'password' ? 'block' : 'none';
                togglePassword.querySelector('.eye-off-icon').style.display = type === 'password' ? 'none' : 'block';
            });
        }

        // --- Offering Type Toggle Logic ---
        const updateOfferingVisibility = () => {
            if (offeringTypeServiceRadio.checked) {
                primaryServiceGroup.style.display = 'block';
                primaryServiceInput.setAttribute('required', 'true');
                primaryProductInput.value = ''; // Clear other field
                primaryProductGroup.style.display = 'none';
                primaryProductInput.removeAttribute('required');
            } else if (offeringTypeProductRadio.checked) {
                primaryProductGroup.style.display = 'block';
                primaryProductInput.setAttribute('required', 'true');
                primaryServiceInput.value = ''; // Clear other field
                primaryServiceGroup.style.display = 'none';
                primaryServiceInput.removeAttribute('required');
            } else {
                primaryServiceInput.value = '';
                primaryProductInput.value = '';
                primaryServiceGroup.style.display = 'none';
                primaryServiceInput.removeAttribute('required');
                primaryProductGroup.style.display = 'none';
                primaryProductInput.removeAttribute('required');
            }
        };

        offeringTypeServiceRadio.addEventListener('change', updateOfferingVisibility);
        offeringTypeProductRadio.addEventListener('change', updateOfferingVisibility);

        const resetSubmitButton = (message = 'Complete Registration') => {
            submitButton.disabled = false;
            submitButton.textContent = message;
        };


        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const displayError = (message) => {
                errorMessageDiv.innerHTML = message; // Use innerHTML to allow for links
                errorMessageDiv.style.display = 'block';
                resetSubmitButton();
            };

            // Clear previous messages and disable button
            errorMessageDiv.style.display = 'none';
            successMessageDiv.style.display = 'none';
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';

            // --- Validation ---
            // Validate password length
            if (passwordInput.value.length < 6) {
                return displayError('Password must be at least 6 characters long.');
            }

            // Validate offering type and primary service/product
            const offeringType = document.querySelector('input[name="offering_type"]:checked');
            if (!offeringType) {
                return displayError('Please select what you offer (Service or Product).');
            }

            if (offeringType.value === 'service' && !primaryServiceInput.value.trim()) {
                return displayError('Please enter your primary service.');
            }

            if (offeringType.value === 'product' && !primaryProductInput.value.trim()) {
                return displayError('Please enter your primary product.');
            }

            // Get form data
            const formData = new FormData(form);
            const email = formData.get('email');
            const password = formData.get('password');
            const fullName = formData.get('full-name');
            const phoneNumber = formData.get('phone-number');
            const location = formData.get('location');
            const selectedOfferingType = formData.get('offering_type');
            const primaryService = formData.get('primary_service');
            const primaryProduct = formData.get('primary_product');

            // --- STEP 1: Sign up the user (fast) ---
            // We only sign up with email and password first for a quick response.
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email: email,
                password: password,
            });

            if (authError) {
                // Provide more user-friendly error messages
                let friendlyMessage = `<strong>Registration failed.</strong> An unexpected error occurred: ${authError.message}`;
                if (authError.message.includes("User already registered")) {
                    friendlyMessage = `<strong>This email is already registered.</strong> Please <a href="login.html" class="text-primary">log in</a> instead.`;
                } else if (authError.message.toLowerCase().includes("password")) {
                    friendlyMessage = `<strong>There's an issue with your password.</strong> Please ensure it meets the requirements (e.g., minimum length).`;
                }

                displayError(friendlyMessage);
                return; // Stop execution if auth fails
            }

            // --- STEP 2: Insert profile data into 'helpas' table (runs after signup succeeds) ---
            // This assumes you have a table named 'helpas' with RLS policies that allow a newly signed-up user to insert their own profile.
            // The 'id' column in 'helpas' should be a foreign key to 'auth.users.id'.
            if (authData.user) {
                const { error: profileError } = await supabase
                    .from('helpas')
                    .insert({ 
                        id: authData.user.id, // Link to the user in auth.users
                        email: email,
                        full_name: fullName,
                        phone_number: phoneNumber,
                        location: location,
                        offering_type: selectedOfferingType,
                        primary_service: selectedOfferingType === 'service' ? primaryService : null,
                        primary_product: selectedOfferingType === 'product' ? primaryProduct : null,
                     });

                if (profileError) {
                    // If profile insertion fails, the user is still signed up.
                    // We should inform them but also log the error for debugging.
                    console.error("Critical: User was created but profile insertion failed:", profileError);
                    
                    // Check for a unique phone number violation
                    if (profileError.message.includes('duplicate key value') && profileError.message.includes('phone_number')) {
                        displayError(`<strong>This phone number is already registered.</strong> Please use a different number or log in if you already have an account.`);
                    } else {
                        displayError(`<strong>Your account was created, but we couldn't save your profile details.</strong> Please contact support. Error: ${profileError.message}`);
                    }
                    return;
                }
            }
            
            if (authData.user) {
                // --- Success ---
                // This part only runs if both signup and profile insertion succeed.
                form.style.display = 'none';
                successMessageDiv.innerHTML = `
                    <h4>Registration Complete. Check Your Email.</h4>
                    <p>Welcome to YourHelpa. We've sent a confirmation link to <strong>${email}</strong>. Please click the link in that email to activate your account.</p>
                `;
                successMessageDiv.style.display = 'block';
                localStorage.removeItem('helpaSignupFormData'); // Clear saved form data
            } else {
                // This case should ideally not be reached if authError is handled, but it's good practice.
                displayError('<strong>Registration failed.</strong> Could not create user account.');
            }
        });

        const localStorageKey = 'helpaSignupFormData';
        const saveFormData = () => {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            // Manually handle radio buttons and conditional fields for persistence
            data.offering_type = document.querySelector('input[name="offering_type"]:checked')?.value || '';
            data.primary_service = primaryServiceInput.value;
            data.primary_product = primaryProductInput.value;
            // Do not save password
            delete data.password;
            localStorage.setItem(localStorageKey, JSON.stringify(data));
        };

        const loadFormData = () => {
            const savedData = localStorage.getItem(localStorageKey);
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    for (const key in data) {
                        const element = form.elements[key];
                        if (!element) continue;

                        if (element.type === 'radio' && element.name === 'offering_type') {
                            element.checked = (element.value === data[key]);
                        } else if (element.type !== 'radio') {
                            element.value = data[key];
                        }
                    }
                    // After loading, update visibility for offering type
                    if (data.offering_type) {
                        updateOfferingVisibility(); // Call to show/hide groups based on loaded radio state
                    }
                } catch (e) {
                    console.error("Error loading form data from localStorage:", e);
                    localStorage.removeItem(localStorageKey); // Clear corrupted data
                }
            }
        };

        // Add event listeners for persistence
        form.addEventListener('input', (e) => {
            if (e.target.type !== 'password') { // Don't save password
                saveFormData();
            }});

        // Load any saved data when the page loads
        document.addEventListener('DOMContentLoaded', loadFormData);

    </script>
</body>
</html>